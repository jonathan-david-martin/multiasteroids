<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ANSWER FUN</title>
    <script src="./js/phaser.min.js" type="text/javascript"></script>
    <script src="./js/jquery-3.1.1.min.js" type="text/javascript" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>

</head>
<body>

<!--<p id="p1">Hello World!</p>-->
<!--<h2>Your sprite will be red on your screen only</h2>-->




<script>

  var game = new Phaser.Game(800, 800, Phaser.AUTO, '', { preload: preload, create: create, update: update})
  var socket = io();

  var updateCounter = 0;

  var players = [];
  var sprites = [];
  var cursors;

  var player = function(x,y,socketid){
    this.x = x;
    this.y = y;
    this.socketid = socketid;

  }

  function screenWrap (sprite) {

    if (sprite.x < 0)
    {
      sprite.x = game.width;
    }
    else if (sprite.x > game.width)
    {
      sprite.x = 0;
    }

    if (sprite.y < 0)
    {
      sprite.y = game.height;
    }
    else if (sprite.y > game.height)
    {
      sprite.y = 0;
    }

  }


  function preload() {
    console.log("starting preload");
    game.load.crossOrigin = 'anonymous';
    game.load.image('phaser', './assets/ship.png');

    //console.log("ending preload");

  }

  function create() {

    //console.log("create");

    game.physics.startSystem(Phaser.Physics.ARCADE);
    var style = { font: "170px Arial", fill: "#ff0000" };
    //var label_A = game.add.text(150, 70, 'A', style);
    var style = { font: "170px Arial", fill: "#00ff00" };
    //var label_B = game.add.text(550, 70, 'B', style);
    var style = { font: "170px Arial", fill: "#0000ff" };
    //var label_C = game.add.text(150, 460, 'C', style);
    var style = { font: "170px Arial", fill: "#ffff00"};
    //var label_D = game.add.text(550, 460, 'D', style);

    var style = { font: "32px Arial", fill: "#ffffff"};
    var leftMsg = game.add.text(20, 610, 'PRESS HERE TO TURN LEFT', style);
    leftMsg.angle = -90;
    var rightMsg = game.add.text(770, 160, 'PRESS HERE TO TURN RIGHT', style);
    rightMsg.angle = 90;
    var upMsg = game.add.text(190, 10, 'PRESS HERE TO THRUST', style);

    //var downMsg = game.add.text(165, 660, 'PRESS HERE TO MOVE DOWN', style);
    var style = { font: "16px Arial", fill: "#ffffff"};
    var keysMsg = game.add.text(240, 50, '*or use the arrow keys on your computer', style);

    //add white text explaining where to click to move

    //game.physics.arcade.defaultRestitution = 0.8;
    cursors = game.input.keyboard.createCursorKeys();
    game.input.addPointer();

    socket.emit('phaser create function initiated');

  }

  socket.on('server knows phaser create initiated',function(data){
    var mystr = socket.id;
    //document.getElementById("p1").innerHTML = "My id:" + mystr.substring(0,4);

    players = data;
    //console.log("server knows phaser create initiated");

    if (sprites.length == 0)
    {
      for (i = 0; i < players.length; i++) {

        sprite = game.add.sprite(players[i].x, players[i].y, 'phaser');

        //sprite.pivot.x = 40;
        //sprite.pivot.y = 40;

        /**
         var style = { font: "20px Arial", fill: "#ffffff" };
         var str = players[i].socketid;
         var label_score = game.add.text(0, -20, str.substring(0,4), style);
         sprite.addChild(label_score);
         **/

        sprite.socketid = players[i].socketid;
        //game.physics.arcade.enable(sprite);

        game.physics.enable(sprite, Phaser.Physics.ARCADE);

        //console.log(players[i]);
        //console.log(players[i].thrust);
        //console.log(players[i].angle);
        //console.log(sprite.body);

        sprite.angle = players[i].angle;
        //sprite.body.(players[i].thrust);
        game.physics.arcade.velocityFromAngle(sprite.angle - 90, players[i].speed,sprite.body.velocity);
        //sprite.body.setZeroDamping();

        //sprite.body.damping = 0.5;
        sprite.body.drag.set(100);
        sprite.body.angularDrag = 500;
        //sprite.body.angulardamping = 0.05;

        //sprite.body.velocity.x = 0;
        //sprite.body.velocity.y = 0;
        //sprite.body.fixedRotation = true;
        //sprite.body.setZeroVelocity();
        if (sprite.socketid == socket.id){
          sprite.tint = 0xff0000;
        }

        sprites.push(sprite);
        console.log(sprite.socketid);
      }
    }
    else{
      sprite = game.add.sprite(players[players.length - 1].x, players[players.length - 1].y, 'phaser');
      sprite.socketid = players[players.length - 1].socketid;

      //sprite.pivot.x = 40;
      //sprite.pivot.y = 40;

      /**
       var style = { font: "20px Arial", fill: "#ffffff" };
       var str = players[i].socketid;
       var label_score = game.add.text(0, -20, str.substring(0,4), style);
       sprite.addChild(label_score);
       **/
      //game.physics.arcade.enable(sprite);

      game.physics.enable(sprite, Phaser.Physics.ARCADE);

      //sprite.body.thrust(players[players.length - 1].thrust);
      sprite.angle = players[players.length - 1].angle;
      game.physics.arcade.velocityFromAngle(sprite.angle - 90, players[players.length - 1].speed,sprite.body.velocity);
      //sprite.body.setZeroDamping();

      //sprite.body.damping = 0.5;
      sprite.body.drag.set(100);
      sprite.body.angularDrag = 500;
      //sprite.body.angulardamping = 0.05;

      //sprite.body.velocity.x = 0;
      //sprite.body.velocity.y = 0;
      //sprite.body.fixedRotation = true;
      //sprite.body.setZeroVelocity();
      if (sprite.socketid == socket.id){
        sprite.tint = 0xff0000;
      }
      sprites.push(sprite);
      //console.log(sprite.socketid);
    }



  });

  socket.on('velocity update',function(data){
    for(i=0;i<players.length;i++) {
      //if (updateCounter > 5) {
      if (sprites[i].socketid != socket.id) {
        sprites[i].x = data[i].x;
        sprites[i].y = data[i].y;
        sprites[i].angle = data[i].angle;
        updateCounter = 0;
        //}
        updateCounter++;
        sprites[i].body.velocity.x = data[i].velocityx;
        sprites[i].body.velocity.y = data[i].velocityy;
      }
    }
    //console.log('velocity update');
  });

  /**
   socket.on('update locations',function(data){
        for(i=0;i<players.length;i++){
            //sprites[i].x = data[i].x;
            //sprites[i].y = data[i].y;
            sprites[i].speed = data[i].speed;
        }
        console.log('update locations');
    });
   **/

  socket.on('update',function(data){
    if (data === []){
      console.log("data is [] so now sprites is []")
      sprites = [];
    }
    else {
      //console.log("data is not empty");
      players = data;
    }

    for(i=0;i<players.length;i++){
      //console.log('setting angle from players:' + players[i].angle)
      //console.log(sprites[i].body);
      sprites[i].angle = players[i].angle;

      if(players[i].x == -999){
        sprites[i].x = -999;
      }
      //sprites[i].body.rotation = 90;
      //console.log(sprites[i].body.rotation);
      if(players[i].x != sprites[i].x || players[i].y != sprites[i].y) {
        sprites[i].body.x = players[i].x;
        sprites[i].body.y = players[i].y;
      }
      //sprites[i].body.thrust(players[i].thrust);
      //console.log('player ' + i + ' speed is' + players[i].speed);
      //console.log('player ' + i + ' velocity is' + sprites[i].body.velocity);

      if(players[i].speed == 400) {
        game.physics.arcade.velocityFromAngle(players[i].angle - 90, players[i].speed, sprites[i].body.velocity);
        //if (players[i].speed == 50) {
        //    players[i].speed = 49
        //}
      }

      //console.log(sprites[i].body.x);
      //console.log(sprites[i].body.y);

      //console.log(sprites[i].y);
    }
  });

  //phaser update
  function update() {
    //console.log(players);

    if(players.length > 0) {
      for(i=0;i<players.length;i++) {
        //players[i].x = sprites[i].body.x;
        //players[i].y = sprites[i].body.y;
        //players[i].angle = sprites[i].body.angle;

        screenWrap(sprites[i]);

        if (players[i].speed > 0) {
          players[i].speed -= 10;
          //game.physics.arcade.velocityFromAngle(players[i].angle - 90, players[i].speed, sprites[i].body.velocity);
          //screenWrap(sprites[i]);
          socket.emit('phaserupdate',players);
          //socket.emit('phaserupdate', players);
        }

          if (players[i].socketid == socket.id) {
            players[i].velocityx = sprites[i].body.velocity.x;
            players[i].velocityy = sprites[i].body.velocity.y;
            players[i].angle = sprites[i].angle;
            if(players[i].x != sprites[i].x || players[i].y != sprites[i].y) {
              players[i].x = sprites[i].x;
              players[i].y = sprites[i].y;
              socket.emit('velocity update', players);
            }

          }



        }





        /**
         if (sprites[i].body.velocity.x <= 0 && sprites[i].body.velocity.y <= 0) {
                    players[i].x = sprites[i].x;
                    players[i].y = sprites[i].y;
                    players[i].angle = sprites[i].angle;
                    socket.emit('no movement',players);
                }
         **/


        //console.log(sprites[i].body.x);
        //console.log(sprites[i].body.y);

      }






    if (cursors.left.isDown)
    {
      socket.emit('left',socket.id);
    }
    else if (cursors.right.isDown)
    {
      socket.emit('right',socket.id);
    }

    if (cursors.up.isDown)
    {
      //for (i = 0;i<players.length;i++){
      //if(players[i].socketid == socket.id){
      //players[i].x = sprites[i].x;
      //players[i].y = sprites[i].y;
      //socket.emit('up',socket.id);
      //game.physics.arcade.velocityFromAngle(45, 800, sprites[0].body.velocity);

      //sprites[0].body.x = 100;
      //sprites[0].body.y = 100;

      socket.emit('up',socket.id);

      //}
      //}

    }
    else if (cursors.down.isDown)
    {
      socket.emit('down',socket.id);
    }

    if(game.input.pointer1.isDown && game.input.pointer1.x<100){
      socket.emit('left',socket.id);
    }
    if(game.input.pointer1.isDown && game.input.pointer1.x>700){
      socket.emit('right',socket.id);
    }
    if(game.input.pointer1.isDown && game.input.pointer1.y<100){
      socket.emit('up',socket.id);
    }
    if(game.input.pointer1.isDown && game.input.pointer1.y>700){
      socket.emit('down',socket.id);
    }



  }


</script>


</body>
</html>